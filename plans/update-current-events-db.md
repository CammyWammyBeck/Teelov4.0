# Plan: Update Current Events → Database Writes

## Summary
Switch `scripts/update_current_events.py` from file logging to saving scraped data into the database. The script will discover current tournaments and run the Draw → Schedule → Results pipeline, using existing ingestion services to write data safely and consistently.

## Goals
1. Persist scraped current events to DB with correct schema mapping.
2. Avoid malformed or duplicate matches when external IDs are missing.
3. Keep the flow aligned with existing ingestion services and match lifecycle rules.

## Current State (What Exists)
- `scripts/update_current_events.py` scrapes draws, schedules, results and logs to a file.
- DB ingestion services are already implemented:
  - `teelo.services.draw_ingestion.ingest_draw`
  - `teelo.services.schedule_ingestion.ingest_schedule`
  - `teelo.services.results_ingestion.ingest_results`
- Tournament/edition upsert logic exists in `scripts/backfill_historical.get_or_create_edition`.

## Target Flow (Per Tournament)
1. **Discover current tournaments**
   - Uses `get_tournaments_for_tour` with a ±7-day window.
2. **Get or create `Tournament` and `TournamentEdition`**
   - Use `get_or_create_edition(session, task_params, tour_key)` with:
     - `tournament_id`, `year`, `tour_key`
     - `tournament_name`, `tournament_level`, `tournament_surface`, `tournament_location`
     - `start_date`, `end_date`
     - `tournament_number` and/or `tournament_url` if applicable
3. **Draw ingestion**
   - Scrape draw entries → `ingest_draw(session, entries, edition, identity_service)`.
4. **Schedule ingestion**
   - Scrape fixtures → `ingest_schedule(session, fixtures, edition)`.
5. **Results ingestion**
   - Scrape results → `ingest_results(session, matches, edition, identity_service)`.
6. **Commit per tournament**
   - Commit after each tournament to keep partial progress if later tournaments fail.

## Data Mapping (What Gets Written)
- **Tournament/TournamentEdition**
  - `Tournament.tournament_code` ← tournament `id`
  - `Tournament.name` ← tournament `name`
  - `Tournament.level` ← tournament `level`
  - `Tournament.surface` ← tournament `surface`
  - `Tournament.city` / `country` ← parsed from `location` if present
  - `TournamentEdition.year` ← `year`
  - `TournamentEdition.start_date` / `end_date` ← tournament list data
  - `TournamentEdition.surface` ← tournament `surface`
- **Matches (Draw)**
  - `round`, `draw_position`, `player_a_id`, `player_b_id`, seeds
  - `status = upcoming` unless draw includes result
  - `score`, `winner_id` if completed
  - `external_id` generated by `draw_ingestion`
- **Matches (Schedule)**
  - `scheduled_date`, `scheduled_datetime`, `court`
  - `status` flips to `scheduled`
- **Matches (Results)**
  - `score`, `score_structured`, `winner_id`, `status`
  - `match_date`, `duration_minutes`, `retirement_set`

## Known Data Integrity Risk
External ID mismatch can create duplicate matches when player IDs are missing:
- Results scrapers fall back to `name`-based IDs.
- Draw ingestion falls back to `draw_{year}_{tournament}_{round}_{position}`.

If the same match is first created from draw (positional ID) and later scraped from results (name-based ID), it can create a duplicate instead of an update.

## Proposed Mitigations (Pick One)
1. **Align external IDs in draw ingestion**
   - When player IDs are missing, fall back to normalized name-based IDs (same style as results).
2. **Add fallback match lookup in results ingestion**
   - If no `external_id` match, attempt lookup by `tournament_edition_id + round + players`.

## Implementation Steps
1. Update `scripts/update_current_events.py` to:
   - Use `get_session()` and `PlayerIdentityService`.
   - Call `get_or_create_edition()` once per tournament.
   - Replace file logging with ingestion calls + summary stats.
2. Add optional `--dry-run` flag to skip DB writes if desired.
3. Apply the chosen external ID mitigation (if needed).
4. Add a concise console summary per tournament + totals.

## Validation Plan
- Run on a single tour (e.g., `ATP`) and confirm:
  - Tournaments and editions created/updated correctly.
  - Draw entries produce `upcoming` matches.
  - Schedule updates `scheduled_*` fields.
  - Results update matches without duplicates.
- If needed, run a small diagnostic to compare external IDs between draw and results for the same tournament.

## Clarifying Questions (Please Answer)
1. Which external ID mitigation do you want:
   - Align draw fallback IDs to name-based format, or
   - Add results fallback lookup by players?
2. Should `update_current_events` support `--dry-run`?
3. Keep any log file output, or only console + DB?

